<div th:fragment="productsTableWithButton">

    <div class="button-container">
        <button class="wa-btn wa-btn-success add-product-btn"
                hx-get="/fragments/product-form"
                hx-target="#formContainer"
                hx-swap="innerHTML">
            <i class="wa-icon wa-icon-plus"></i> Add Product
        </button>
    </div>

    <div id="formContainer" class="form-container"></div>

    <table>
        <thead>
        <tr>
            <th>#</th>
            <th>ID</th>
            <th>Title</th>
            <th>Vendor</th>
            <th>Type</th>
            <th>Price</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="product, iterStat : ${products}">
            <td th:text="${iterStat.index + 1}"></td>
            <td th:text="${product.id}"></td>
            <td th:text="${product.title}"></td>
            <td th:text="${product.vendor}"></td>
            <td th:text="${product.productType}"></td>
            <td th:text="${product.price}"></td>
            <td>
                <!-- Update link -->
                <a th:href="@{/products/{id}/edit(id=${product.id})}"
                   class="load-btn wa-btn"
                   style="text-decoration: none; padding: 6px 12px; font-size: 12px; margin-right: 6px;">
                    Update
                </a>

                <!-- Delete button opens dialog -->
                <button type="button"
                        class="load-btn wa-btn"
                        style="background-color: #b51e1e; padding: 6px 12px; font-size: 12px;"
                        th:attr="data-product-id=${product.id}, data-product-title=${product.title}"
                        onclick="openDeleteDialog(this)">
                    Delete
                </button>
            </td>
        </tr>
        </tbody>
    </table>

    <!-- Styled delete confirmation dialog -->
    <dialog id="deleteDialog" class="delete-dialog"
            onclick="if (event.target === this) this.close()">
        <form id="deleteForm" method="post" class="delete-form">
            <div class="delete-header">
                <i class="wa-icon wa-icon-triangle-exclamation"></i>
                <span>Confirm deletion</span>
            </div>

            <p id="deleteMessage" class="delete-message">
                Are you sure you want to delete this product?
            </p>

            <div class="delete-actions">
                <button type="button" class="load-btn wa-btn" onclick="closeDeleteDialog()">
                    Cancel
                </button>
                <button type="submit" class="load-btn wa-btn" style="background-color: #b51e1e;">
                    Delete
                </button>
            </div>
        </form>
    </dialog>

    <style>
        .delete-dialog::backdrop {
            background: rgba(0, 0, 0, 0.4);
        }

        .delete-dialog {
            border: none;
            padding: 0;
            border-radius: 16px;
            box-shadow: 0 14px 30px rgba(0, 0, 0, 0.25);
            max-width: 420px;
            width: 90%;
        }

        .delete-form {
            background: #f1cdf8;
            padding: 24px 28px 20px;
            border-radius: 16px;
            font-family: Arial, sans-serif;
        }

        .delete-header {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #3c144e;
        }

        .delete-header .wa-icon {
            color: #b51e1e;
        }

        .delete-message {
            margin: 8px 0 18px;
            text-align: left;
        }

        .delete-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 10px;
        }

        .delete-actions .load-btn {
            padding: 8px 16px;
            font-size: 13px;
        }
    </style>

    <script>
        function openDeleteDialog(button) {
            const id = button.getAttribute('data-product-id');
            const title = button.getAttribute('data-product-title');

            const dialog = document.getElementById('deleteDialog');
            const form = document.getElementById('deleteForm');
            const message = document.getElementById('deleteMessage');

            message.textContent = `Are you sure you want to delete product "${title}" (ID: ${id})?`;
            form.action = `/products/${id}/delete`;

            dialog.showModal();
        }

        function closeDeleteDialog() {
            document.getElementById('deleteDialog').close();
        }

        // Close Add Product form when clicking outside it
        document.addEventListener('click', function (event) {
            const formContainer = document.getElementById('formContainer');
            if (!formContainer) return;

            const form = formContainer.querySelector('.product-form');
            const addButton = document.querySelector('.add-product-btn');

            // No form currently shown → nothing to do
            if (!form) return;

            const clickedInsideForm = event.target.closest('.product-form') !== null;
            const clickedAddButton = addButton && addButton.contains(event.target);

            // If click is NOT inside form and NOT on the "Add Product" button → close form
            if (!clickedInsideForm && !clickedAddButton) {
                formContainer.innerHTML = '';
            }
        });
    </script>

</div>